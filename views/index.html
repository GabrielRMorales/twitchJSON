<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Twitch Streams!</title>
    <link rel="stylesheet" type="text/css" href="./main.css">

    <script src="https://code.jquery.com/jquery-3.5.1.js"
        integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>
    <style>
      body {
        background-color: #3f729b;
      }

      .twitch-preview {
        border: 1px solid black;
        padding-left: 5%;
        padding-bottom: 1%;
      }

    </style>
</head>

<body>

    <body>

        <!-- Add your site or application content here -->
        <main>
            <h1 style="color: black">The Top 5 Twitch Streamers</h1>
            <div class="container container-fluid" style="margin-bottom: 15px">
                <input type="text" id="search" />
                <button id="user-search">Search by User</button>

            </div>

        </main>
        <script type="text/javascript">
            const userLog = [];
            const addGameDetails = (info) => {
                //make sure it doesn't get a user whose already on the page
                let newContainer = document.createElement("div");
                const classValues = ["row", "panel", "panel-default", "twitch-preview"];
                classValues.forEach((className) => {
                    newContainer.classList.add(className);
                });
                newContainer.innerHTML = `<h2>${info.title}</h2>`;
                newContainer.innerHTML += `<h3>USER: ${info.user_name}</h3>`;
                newContainer.innerHTML += `<img src=${info.thumbnail_url}>`;
                newContainer.innerHTML += `<p>VIEWER COUNT: ${info.viewer_count}</p>`;
                newContainer.innerHTML += "<button class='remove'>Remove this</button>";
                document.querySelector("main").appendChild(newContainer);
                newContainer.querySelector(".remove").addEventListener("click", function(){
                  newContainer.parentNode.removeChild(newContainer);
                });
                userLog.push(info.user_name);
            };
            //Note: to get the authorization first required a post request using my api client_id and client_secret(generated by Twitch)
            //The post response returned the authorization token which is used below
            //It would be possible to make the post request here as well, but it was done in postman, prior to this part
            const twitchCall = (url="")=>{
                return $.ajax({
                    url: "https://api.twitch.tv/helix/streams"+url,
                    headers: {
                        "Authorization": "Bearer p9z1a915572mw91xpd7swjk4m2hsho",
                        "Client-ID": "5y0vg6nkl91uo7hhvh1epi93nd6e4q"
                    }
                });
            }
                   
           twitchCall().then(function(res) {              
                let results = res.data.slice(0, 5);
                let displayDetails = results.map((result) =>{
                    result.thumbnail_url = result.thumbnail_url.replace(/{height}/, "100")
                        .replace(/{width}/, "100");
                    return result;
                    
                });
                displayDetails.forEach(addGameDetails);
                console.log(results);
            }).catch(function (err) {
                console.log(err);
            });

            const getUser = () => {
              //OgamingSC2
              let user = document.getElementById("search")
                        .value;
              let urlAddon = "?user_login=" + user;
              new Promise(function(resolve, reject){
                if (userLog.indexOf(user)===-1){
                  resolve();
                }
                else {
                  reject();
                }
              }).then(function(){
                return twitchCall(urlAddon);
              }).then(data => {
                    //do stuff with data
                    let formattedData = data["data"][0];
                    formattedData.thumbnail_url = formattedData.thumbnail_url.replace(/{height}/, "100")
                        .replace(/{width}/, "100");
                    console.log(formattedData);
                    addGameDetails(formattedData);                    
                }).catch(err => {
                  console.log(err);
                  // alert("Could not locate that user. Please try a different user.");
                });
                document.getElementById("search")
                        .value="";
            }

            document.getElementById("user-search").addEventListener("click", getUser);
        </script>
    </body>

</html>