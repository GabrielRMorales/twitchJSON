<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Twitch Streams!</title>
    <link href="../src/normalize.css">
    <link href="../src/main.css">
    <script src="https://code.jquery.com/jquery-3.5.1.js"
        integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>

</head>

<body>

    <body>

        <!-- Add your site or application content here -->
        <main>
            <h1 style="color: #3f729b">The Top 5 Twitch Streamers</h1>
            <div class="container container-fluid" style="margin-bottom: 15px">
                <input type="text" id="search" />
                <button id="user-search">Search for User</button>

            </div>

        </main>
        <script type="text/javascript">
            const addGameDetails = (info) => {
                let newContainer = document.createElement("div");
                const classValues = ["row", "panel", "panel-default"];
                classValues.forEach((className) => {
                    newContainer.classList.add(className);
                });
                newContainer.innerHTML = `<h2>${info[0]}</h2>`;
                newContainer.innerHTML += `<h3>USER: ${info[1]}</h3>`;
                newContainer.innerHTML += `<img src=${info[2]}>`;
                newContainer.innerHTML += `<p>VIEWER COUNT: ${info[3]}</p>`;
                document.querySelector("main").appendChild(newContainer);
            };
            //Note: to get the authorization first required a post request using my api client_id and client_secret(generated by Twitch)
            //The post response returned the authorization token which is used below
            //It would be possible to make the post request here as well, but it was done in postman, prior to this part
            const twitchCall = (url)=>{
              return $.ajax({
                url: "https://api.twitch.tv/helix/"+url,
                headers: {
                    "Authorization": "Bearer p9z1a915572mw91xpd7swjk4m2hsho",
                    "Client-ID": "5y0vg6nkl91uo7hhvh1epi93nd6e4q"
                }
              });
            }
                        
            twitchCall("streams").then(function (res) {              
                let results = res.data.slice(0, 5);
                let displayDetails = results.map((result) => {
                    result.thumbnail_url = result.thumbnail_url.replace(/{height}/, "100")
                        .replace(/{width}/, "100");
                    return [result.title, result.user_name, result.thumbnail_url, result.viewer_count];
                });
                displayDetails.forEach(addGameDetails);
                console.log(results);
            }).catch(function (err) {
                console.log(err);
            });

            const getUser = () => {
              let url = "users?login=" + document.getElementById("search")
                        .value;
              twitchCall(url).then(data => {
                    //do stuff with data
                    addGameDetails(data);
                    console.log(data)
                }).catch(err => console.log(err));
            }

            document.getElementById("user-search").addEventListener("click", getUser);
        </script>
    </body>

</html>